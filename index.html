<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>YesPrint | Marketplace + Agent Dashboard (HTML)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons (Vanilla) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- HTML -> Canvas (for invoice PNG download) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{ --safe-b: env(safe-area-inset-bottom, 0px); }
    .pb-safe { padding-bottom: calc(0.75rem + var(--safe-b)); }
    .animate-fade-in { animation: fadeIn .35s ease-out both; }
    .animate-fade-in-up { animation: fadeInUp .5s ease-out both; }
    .animate-pop { animation: pop .25s ease-out both; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(14px) } to { opacity: 1; transform: translateY(0) } }
    @keyframes pop { from { transform: scale(.98); opacity: .6 } to { transform: scale(1); opacity: 1 } }

    .hscroll { -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .hscroll::-webkit-scrollbar{ display:none; }

    /* Elements excluded from invoice PNG capture */
    .no-capture { display: none !important; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 overflow-x-hidden">
  <!-- Live Ticker -->
  <div id="liveTicker" class="bg-black text-white text-xs py-2 px-4 flex items-center justify-center gap-2 overflow-hidden whitespace-nowrap z-50 relative">
    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
    <span id="tickerMsg" class="font-mono font-bold tracking-wide animate-fade-in-up">Sola just earned â‚¦2,500 comm...</span>
  </div>

  <div id="app"></div>
  <div id="modalRoot"></div>

  <script>
    // -----------------------------
    // Constants & Mock Data
    // -----------------------------
    const TIERS = {
      standard: { name: 'Standard', depth: 2, price: 0, color: 'gray', theme: { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-800', dot: 'bg-gray-500' } },
      silver:   { name: 'Silver',   depth: 3, price: 5000, color: 'blue', theme: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', dot: 'bg-blue-500' } },
      gold:     { name: 'Gold',     depth: 5, price: 20000, color: 'yellow', theme: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800', dot: 'bg-yellow-500' } },
      diamond:  { name: 'Diamond',  depth: 9, price: 100000, color: 'purple', theme: { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-800', dot: 'bg-purple-500' } }
    };

    // Withdrawal rules per tier (jobs/month) to unlock NETWORK earnings withdrawal
    const WITHDRAW_RULES = {
      standard: 8,
      silver: 10,
      gold: 12,
      diamond: 6
    };

    // Used for upgrade incentive numbers (kept for calculations; UI text kept simple)
    const AVG_COMMISSION_PER_JOB = 20; // â‚¦20 per job average
    const AVG_JOBS_PER_PERSON_PER_DAY = 1; // 1 job/day per person

    const MOCK_USER_PROFILE = {
      uid: 'user-root',
      fullName: 'Emeka Printer',
      phone: '08012345678',
      bankName: 'GTBank',
      accountNumber: '0123456789',
      myCode: 'EMEK88',
      referredBy: 'upl-001',
      walletBalance: 125500,
      networkEarnings: 45500,  // locked until rule met
      jobProfits: 80000,       // withdrawable anytime
      totalJobs: 12,
      jobsThisMonth: 2,
      membershipTier: 'standard',
      networkCount: 32,
      createdAt: { seconds: Date.now() / 1000 }
    };

    const MOCK_BUSINESSES = [
      { id: 'biz-1', name: 'Morg Plaza Global Prints', location: 'Area 10', verified: true },
      { id: 'biz-2', name: 'UTC Area 10 Graphics', location: 'Garki', verified: false },
      { id: 'biz-3', name: 'Shomolu Standard Press', location: 'Lagos/Abuja', verified: true },
      { id: 'biz-4', name: 'Banex Digital Hub', location: 'Wuse 2', verified: true },
      { id: 'biz-5', name: 'Emeka & Sons Large Format', location: 'Gwagwalada', verified: false }
    ];

    const JOB_TYPES = [
      'Flex Banner (Large)', 'SAV Sticker', 'Flyers (1000pcs)', 'Business Cards',
      'Letterhead', 'Direct Image (DI)', 'Vehicle Branding', 'T-Shirt Heat Transfer',
      'Monogram / Embroidery', 'Roll-up Banner', 'Wedding IVs', 'Custom'
    ];

    const MARKET_CATEGORIES = [
      'All', 'Banners', 'Flyers', 'Stickers', 'Branding', 'Stationery', 'Apparel', 'Embroidery'
    ];

    const MOCK_PRINTERS = [
      {
        id: 'p-001',
        businessId: 'biz-1',
        handle: '@morgplazaprints',
        name: 'Morg Plaza Global Prints',
        location: 'Area 10, Abuja',
        verified: true,
        rating: 4.8,
        followers: 18240,
        responseMins: 12,
        delivery: true,
        minOrderNote: 'Walk-in + Dispatch available',
        services: ['Banners','Flyers','Stickers','Branding'],
        priceList: [
          { sku:'SKU-BNR-001', category:'Banners', name:'Flex Banner (2ft x 4ft)', unit:'per piece', price: 3500, minQty: 1, turnaround:'Same day', suggestedCost: 3000 },
          { sku:'SKU-RUP-001', category:'Banners', name:'Roll-up Banner (Standard)', unit:'per piece', price: 18000, minQty: 1, turnaround:'24 hrs', suggestedCost: 16000 },
          { sku:'SKU-FLY-001', category:'Flyers', name:'Flyers A5 (1000pcs)', unit:'per 1000', price: 9000, minQty: 1, turnaround:'24â€“48 hrs', suggestedCost: 8000 },
          { sku:'SKU-STK-001', category:'Stickers', name:'SAV Sticker (100pcs)', unit:'per 100', price: 6500, minQty: 1, turnaround:'24 hrs', suggestedCost: 6000 }
        ]
      },
      {
        id: 'p-002',
        businessId: 'biz-4',
        handle: '@banexdigitalhub',
        name: 'Banex Digital Hub',
        location: 'Wuse 2, Abuja',
        verified: true,
        rating: 4.6,
        followers: 9100,
        responseMins: 18,
        delivery: true,
        minOrderNote: 'Delivery within Abuja',
        services: ['Branding','Stationery','Stickers'],
        priceList: [
          { sku:'SKU-BC-001', category:'Stationery', name:'Business Cards (100pcs)', unit:'per 100', price: 4500, minQty: 1, turnaround:'Same day', suggestedCost: 3800 },
          { sku:'SKU-LHD-001', category:'Stationery', name:'Letterhead (100pcs)', unit:'per 100', price: 5200, minQty: 1, turnaround:'24 hrs', suggestedCost: 4500 },
          { sku:'SKU-VBR-001', category:'Branding', name:'Vehicle Branding (Sedan)', unit:'per job', price: 65000, minQty: 1, turnaround:'48 hrs', suggestedCost: 60000 },
          { sku:'SKU-DI-001', category:'Branding', name:'Direct Image (DI) Print (A3)', unit:'per sheet', price: 1200, minQty: 10, turnaround:'Same day', suggestedCost: 1000 }
        ]
      },
      {
        id: 'p-003',
        businessId: 'biz-3',
        handle: '@shomolustandardpress',
        name: 'Shomolu Standard Press',
        location: 'Lagos / Abuja (Dispatch)',
        verified: true,
        rating: 4.7,
        followers: 30110,
        responseMins: 9,
        delivery: true,
        minOrderNote: 'Nationwide dispatch',
        services: ['Flyers','Stickers','Stationery','Banners'],
        priceList: [
          { sku:'SKU-FLY-002', category:'Flyers', name:'Flyers A4 (1000pcs)', unit:'per 1000', price: 14000, minQty: 1, turnaround:'24 hrs', suggestedCost: 12000 },
          { sku:'SKU-STK-002', category:'Stickers', name:'Die-cut Sticker (50pcs)', unit:'per 50', price: 9500, minQty: 1, turnaround:'48 hrs', suggestedCost: 8500 },
          { sku:'SKU-IV-001', category:'Stationery', name:'Wedding IV Pack (100)', unit:'per pack', price: 55000, minQty: 1, turnaround:'72 hrs', suggestedCost: 50000 },
          { sku:'SKU-BNR-002', category:'Banners', name:'Backdrop Banner (8ft x 10ft)', unit:'per piece', price: 38000, minQty: 1, turnaround:'48 hrs', suggestedCost: 35000 }
        ]
      },
      {
        id: 'p-004',
        businessId: 'biz-2',
        handle: '@utcgraphics',
        name: 'UTC Area 10 Graphics',
        location: 'Garki, Abuja',
        verified: false,
        rating: 4.2,
        followers: 3200,
        responseMins: 35,
        delivery: false,
        minOrderNote: 'Pickup only',
        services: ['Flyers','Stationery'],
        priceList: [
          { sku:'SKU-FLY-003', category:'Flyers', name:'Flyers A6 (1000pcs)', unit:'per 1000', price: 7000, minQty: 1, turnaround:'48 hrs', suggestedCost: 6500 },
          { sku:'SKU-REC-001', category:'Stationery', name:'Receipt Book (1 booklet)', unit:'per booklet', price: 2500, minQty: 2, turnaround:'48 hrs', suggestedCost: 2200 },
          { sku:'SKU-INV-001', category:'Stationery', name:'Invoice Book (1 booklet)', unit:'per booklet', price: 2800, minQty: 2, turnaround:'48 hrs', suggestedCost: 2500 }
        ]
      },
      {
        id: 'p-005',
        businessId: 'biz-5',
        handle: '@emekasonslargeformat',
        name: 'Emeka & Sons Large Format',
        location: 'Gwagwalada, Abuja',
        verified: false,
        rating: 4.4,
        followers: 5100,
        responseMins: 22,
        delivery: true,
        minOrderNote: 'Large format specialist',
        services: ['Banners','Branding'],
        priceList: [
          { sku:'SKU-BNR-003', category:'Banners', name:'Flex Banner (4ft x 8ft)', unit:'per piece', price: 12500, minQty: 1, turnaround:'24 hrs', suggestedCost: 11000 },
          { sku:'SKU-3D-001', category:'Branding', name:'3D Signage (Small)', unit:'per job', price: 85000, minQty: 1, turnaround:'5â€“7 days', suggestedCost: 80000 },
          { sku:'SKU-BRD-001', category:'Branding', name:'Shop Branding (Basic)', unit:'per job', price: 120000, minQty: 1, turnaround:'7â€“10 days', suggestedCost: 110000 }
        ]
      }
    ];

    // -----------------------------
    // State
    // -----------------------------
    const state = {
      view: 'landing',
      isRegistering: false,
      loading: false,
      user: null,
      userData: null,
      authForm: { fullName:'', phone:'', bankName:'', accountNumber:'', pin:'', referralCode:'', email:'', password:'' },
      jobs: [],
      pendingJob: null,
      showInvoice: false,
      flashMsg: null,
      binaryTree: null,

      mp: {
        search: '',
        category: 'All',
        location: 'All',
        sort: 'Recommended',
        viewType: 'list', // list | grid
        following: {},
        openPrinterId: null
      },

      jobDraft: null,

      upgrade: {
        selectedTier: null,
        paid: false
      }
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    const el = (id) => document.getElementById(id);
    const fmt = (n) => (Number(n) || 0).toLocaleString();
    const tier = () => TIERS[state.userData?.membershipTier || 'standard'];
    const nowSec = () => Math.floor(Date.now()/1000);

    function jobsNeededToUnlockNetworkWithdraw() {
      const t = state.userData?.membershipTier || 'standard';
      return WITHDRAW_RULES[t] ?? 8;
    }

    function isNetworkWithdrawUnlocked() {
      const jobsThisMonth = state.userData?.jobsThisMonth || 0;
      return jobsThisMonth >= jobsNeededToUnlockNetworkWithdraw();
    }

    function peopleUnderUser(depth) {
      return Math.max(0, (2 ** (depth + 1)) - 2);
    }

    function potentialEarningsFromDepth(depth) {
      const people = peopleUnderUser(depth);
      const daily = people * AVG_JOBS_PER_PERSON_PER_DAY * AVG_COMMISSION_PER_JOB;
      const monthly = daily * 30;
      return { people, daily, monthly };
    }

    function toast(type, text) {
      state.flashMsg = { type, text };
      render();
      setTimeout(() => { state.flashMsg = null; render(); }, 4200);
    }

    function setView(v) {
      state.view = v;
      render();
    }

    function icon(name, cls="w-5 h-5") {
      return `<i data-lucide="${name}" class="${cls}"></i>`;
    }

    function Card(inner, extra="") {
      return `<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${extra}">${inner}</div>`;
    }

    function Button(inner, opts={}) {
      const variant = opts.variant || 'primary';
      const type = opts.type || 'button';
      const disabled = !!opts.disabled;
      const id = opts.id || '';
      const cls = opts.className || '';
      const dataNav = opts.dataNav ? `data-nav="${opts.dataNav}"` : '';
      const dataAction = opts.dataAction ? `data-action="${opts.dataAction}"` : '';

      const base = "px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center justify-center gap-2 transform active:scale-95";
      const variants = {
        primary:  "bg-gradient-to-r from-green-600 to-green-500 text-white hover:shadow-lg hover:shadow-green-200 hover:-translate-y-0.5",
        secondary:"bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-green-200",
        outline:  "border-2 border-green-600 text-green-600 hover:bg-green-50",
        danger:   "bg-red-50 text-red-600 hover:bg-red-100",
        cta:      "bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-xl shadow-orange-200 hover:shadow-2xl hover:-translate-y-1 text-lg",
        black:    "bg-gray-900 text-white hover:bg-black shadow-lg"
      };

      return `
        <button ${id ? `id="${id}"` : ''} ${dataNav} ${dataAction} type="${type}" ${disabled ? 'disabled' : ''}
          class="${base} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${cls}">
          ${inner}
        </button>
      `;
    }

    function badgeVerified() {
      return `
        <span class="inline-flex items-center gap-1 text-xs font-bold bg-blue-50 text-blue-700 border border-blue-100 px-2 py-0.5 rounded-full">
          ${icon('badge-check','w-4 h-4')} Verified
        </span>
      `;
    }

    function stars(rating) {
      const r = Math.max(0, Math.min(5, rating || 0));
      const full = Math.floor(r);
      const half = (r - full) >= 0.5 ? 1 : 0;
      const empty = 5 - full - half;
      let html = '';
      for (let i=0;i<full;i++) html += `<span class="text-yellow-500">${icon('star','w-4 h-4 fill-yellow-500')}</span>`;
      if (half) html += `<span class="text-yellow-500">${icon('star-half','w-4 h-4')}</span>`;
      for (let i=0;i<empty;i++) html += `<span class="text-gray-300">${icon('star','w-4 h-4')}</span>`;
      return `<div class="flex items-center gap-1">${html}<span class="text-xs text-gray-500 ml-1">${rating.toFixed(1)}</span></div>`;
    }

    function svgThumb(seedText, big=false) {
      let h = 0;
      for (let i=0;i<seedText.length;i++) h = (h*31 + seedText.charCodeAt(i)) >>> 0;
      const a = (h % 360);
      const b = ((h/3) % 360);
      const c = ((h/7) % 360);
      const w = big ? 1000 : 600;
      const hgt = big ? 900 : 700;
      const title = seedText.replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${hgt}" viewBox="0 0 ${w} ${hgt}">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="hsl(${a},90%,55%)"/>
              <stop offset="55%" stop-color="hsl(${b},85%,55%)"/>
              <stop offset="100%" stop-color="hsl(${c},85%,48%)"/>
            </linearGradient>
            <filter id="blur" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="${big?24:18}"/>
            </filter>
          </defs>
          <rect width="100%" height="100%" fill="#0b0b0b"/>
          <circle cx="${w*0.25}" cy="${hgt*0.3}" r="${big?180:140}" fill="url(#g)" opacity=".85" filter="url(#blur)"/>
          <circle cx="${w*0.75}" cy="${hgt*0.45}" r="${big?220:170}" fill="url(#g)" opacity=".55" filter="url(#blur)"/>
          <circle cx="${w*0.52}" cy="${hgt*0.78}" r="${big?260:190}" fill="url(#g)" opacity=".35" filter="url(#blur)"/>
          <rect x="${big?60:40}" y="${big?60:40}" width="${w-(big?120:80)}" height="${hgt-(big?120:80)}" rx="${big?44:36}" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.12)"/>
          <text x="50%" y="52%" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="${big?54:40}" fill="rgba(255,255,255,0.92)" font-weight="800">
            ${title.slice(0,28)}
          </text>
          <text x="50%" y="60%" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="${big?20:16}" fill="rgba(255,255,255,0.65)" font-weight="600">
            Marketplace â€¢ Price-ready
          </text>
        </svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    // -----------------------------
    // Live Ticker
    // -----------------------------
    (function initTicker() {
      const messages = [
        "ðŸ”¥ Musa in Area 10 just withdrew â‚¦45,000",
        "ðŸš€ New Silver Member: Chioma from Wuse 2",
        "ðŸ’¸ 1000 Flyers job completed - â‚¦8,000 profit",
        "âš ï¸ Diamond spots are limited this month",
        "âœ… Instant payouts active for GTB and Zenith"
      ];
      let i = 0;
      setInterval(() => {
        i = (i + 1) % messages.length;
        const node = el('tickerMsg');
        if (!node) return;
        node.classList.remove('animate-fade-in-up');
        void node.offsetWidth;
        node.textContent = messages[i];
        node.classList.add('animate-fade-in-up');
      }, 4000);
    })();

    // -----------------------------
    // Network Tree (mock)
    // -----------------------------
    function generateNetworkTree(depth, currentId = "root", level=0) {
      if (depth === 0) return null;
      return {
        id: currentId,
        level,
        name: currentId === "root" ? "You" : `Agent-${currentId.substring(0,3)}`,
        sales: Math.floor(Math.random() * 50000),
        left: Math.random() > 0.1 ? generateNetworkTree(depth - 1, `${currentId}L`, level+1) : null,
        right: Math.random() > 0.2 ? generateNetworkTree(depth - 1, `${currentId}R`, level+1) : null
      };
    }

    function flattenTree(node, out=[]) {
      if (!node) return out;
      out.push(node);
      if (node.left) flattenTree(node.left, out);
      if (node.right) flattenTree(node.right, out);
      return out;
    }

    // -----------------------------
    // Auth (Mock)
    // -----------------------------
    function handleAuthSubmit(e) {
      e.preventDefault();
      if (state.loading) return;
      state.loading = true;
      render();

      setTimeout(() => {
        const mockUid = state.isRegistering ? `user-${Math.floor(Math.random()*1000)}` : 'user-root';
        state.user = { uid: mockUid, email: state.authForm.email || 'user@yesprint.com' };

        state.userData = state.isRegistering ? {
          ...MOCK_USER_PROFILE,
          uid: mockUid,
          fullName: state.authForm.fullName,
          phone: state.authForm.phone,
          bankName: state.authForm.bankName,
          accountNumber: state.authForm.accountNumber,
          walletBalance: 0,
          networkEarnings: 0,
          jobProfits: 0,
          jobsThisMonth: 0,
          totalJobs: 0,
          myCode: (state.authForm.fullName.substring(0, 3) + Math.floor(1000 + Math.random() * 9000)).toUpperCase(),
          membershipTier: 'standard'
        } : { ...MOCK_USER_PROFILE };

        state.jobs = state.isRegistering ? [] : [
          { id: 'INV-1111', jobTitle: 'Mock Banner', businessName: 'Morg Plaza', amount: 50000, agentProfit: 5000, status: 'Completed', createdAt: { seconds: nowSec() } }
        ];

        state.binaryTree = generateNetworkTree(9);
        state.loading = false;
        state.view = 'dashboard';
        render();
      }, 900);
    }

    function updateAuthForm(name, value) { state.authForm[name] = value; }

    // -----------------------------
    // Job Flow
    // -----------------------------
    function generateInvoiceFromForm(form) {
      const costPrice = parseFloat(form.costPrice.value || '0');
      const margin = parseFloat(form.margin.value || '0');
      const totalAmount = costPrice + margin;

      const businessId = form.businessId.value;
      const business = MOCK_BUSINESSES.find(b => b.id === businessId);

      // Job type: if Custom, use the custom input value
      let jobType = form.jobType.value;
      if (jobType === 'Custom') {
        const custom = (form.customJobType?.value || '').trim();
        if (!custom) {
          toast('error', 'Please enter your custom category.');
          return;
        }
        jobType = custom;
      }

      const jobData = {
        id: `INV-${Date.now()}`,
        businessId,
        businessName: business ? business.name : 'Unknown',
        jobTitle: form.jobTitle.value,
        jobType,
        costPrice,
        margin,
        amount: totalAmount,
        agentProfit: 0,
        status: 'Pending',
        createdAt: { seconds: nowSec() }
      };

      state.jobs = [jobData, ...state.jobs];
      state.pendingJob = jobData;
      state.showInvoice = true;
      state.jobDraft = null;
      render();
    }

    function confirmJobPayment(jobId) {
      const idx = state.jobs.findIndex(j => j.id === jobId);
      if (idx === -1) return;
      const job = state.jobs[idx];
      if (job.status === 'Completed') return;

      const networkDeduction = job.margin * 0.20;
      const agentNetProfit = job.margin - networkDeduction;

      state.jobs[idx] = {
        ...job,
        agentProfit: agentNetProfit,
        networkFee: networkDeduction,
        status: 'Completed'
      };

      const nextJobProfits = (state.userData.jobProfits || 0) + agentNetProfit;
      const nextNetworkEarnings = (state.userData.networkEarnings || 0) + networkDeduction;
      const nextWallet = nextJobProfits + nextNetworkEarnings;

      state.userData = {
        ...state.userData,
        jobProfits: nextJobProfits,
        networkEarnings: nextNetworkEarnings,
        walletBalance: nextWallet,
        totalJobs: (state.userData.totalJobs || 0) + 1,
        jobsThisMonth: (state.userData.jobsThisMonth || 0) + 1
      };

      if (state.pendingJob && state.pendingJob.id === jobId) {
        state.pendingJob = null;
        state.showInvoice = false;
        state.view = 'payment-success';
      }
      render();
    }

    function handleDirectWithdrawalRequest() {
      const amt = state.userData?.jobProfits || 0;
      if (amt <= 0) return toast('error', 'No direct profit available yet.');
      toast('success', 'Withdrawal request sent for Direct Profit. Youâ€™ll be credited after review.');
    }

    function handleNetworkWithdrawalRequest() {
      const amt = state.userData?.networkEarnings || 0;
      if (amt <= 0) return toast('error', 'No network earnings available yet.');

      const req = jobsNeededToUnlockNetworkWithdraw();
      const jobsThisMonth = state.userData?.jobsThisMonth || 0;

      if (jobsThisMonth < req) {
        return toast('error', `Network withdrawals unlock at ${req} jobs this month. You have ${jobsThisMonth}.`);
      }
      toast('success', 'Withdrawal request sent for Network Earnings. Youâ€™ll be credited after review.');
    }

    // -----------------------------
    // Invoice Modal controls
    // -----------------------------
    function closeInvoice(goDashboardIfNewJob = false) {
      state.showInvoice = false;
      state.pendingJob = null;
      if (goDashboardIfNewJob && state.view === 'new-job') state.view = 'dashboard';
      render();
    }

    function copyText(text) {
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(() => toast('success', 'Copied.'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        toast('success', 'Copied.');
      }
    }

    async function downloadInvoicePng() {
      const inv = document.getElementById('invoiceCapture');
      if (!inv) return;

      document.querySelectorAll('.capture-exclude').forEach(x => x.classList.add('no-capture'));

      try {
        const canvas = await html2canvas(inv, {
          backgroundColor: "#ffffff",
          scale: Math.min(2, window.devicePixelRatio || 1),
          useCORS: true
        });
        const dataUrl = canvas.toDataURL("image/png");
        const jobId = state.pendingJob?.id ? String(state.pendingJob.id).replace(/[^a-zA-Z0-9_-]/g,'') : 'invoice';
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `YESPRINT_${jobId}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast('success', 'Invoice downloaded.');
      } catch (e) {
        console.error(e);
        toast('error', 'Could not generate PNG. Try again.');
      } finally {
        document.querySelectorAll('.capture-exclude').forEach(x => x.classList.remove('no-capture'));
      }
    }

    // -----------------------------
    // Network rendering
    // -----------------------------
    function renderTreeNode(node, level, maxDepth) {
      if (!node) {
        if (level < 2) {
          return `
            <div class="flex flex-col items-center mx-2 opacity-30">
              <div class="w-8 h-8 rounded-full border border-dashed border-gray-400"></div>
            </div>`;
        }
        return '';
      }

      const isLocked = level > maxDepth;
      const isRoot = level === 0;

      const nodeSize = isRoot ? 'w-16 h-16 border-4 mb-4' : 'w-10 h-10 border-2 mb-2';
      const nodeColor = isLocked ? 'bg-gray-200 border-gray-300' : 'bg-white border-green-500';
      const textColor = isLocked ? 'text-gray-400' : 'text-gray-700';

      const badge = (!isRoot && !isLocked)
        ? `<div class="absolute -bottom-1 -right-1 bg-green-100 text-green-800 text-[8px] px-1 rounded-full font-bold border border-green-200">â‚¦${Math.floor((node.sales||0)/1000)}k</div>`
        : '';

      const rootTag = isRoot
        ? `<div class="absolute top-16 bg-green-600 text-white text-[10px] px-2 py-0.5 rounded-full z-20">You</div>`
        : '';

      const centerIconOrText = isLocked
        ? `<span class="text-gray-400">${icon('lock', 'w-4 h-4')}</span>`
        : `<span class="font-bold ${textColor} ${isRoot ? 'text-lg' : 'text-xs'}">${(node.name || '').substring(0,1)}</span>`;

      const hasChildren = !!(node.left || node.right);

      const connectors = hasChildren ? `
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-2 flex justify-center">
          <div class="w-px h-full bg-gray-300 absolute top-0"></div>
          <div class="w-[80%] h-px bg-gray-300 absolute top-2"></div>
        </div>` : '';

      const leftLine = node.left ? `<div class="h-2 w-px bg-gray-300 mb-0"></div>` : '';
      const rightLine = node.right ? `<div class="h-2 w-px bg-gray-300 mb-0"></div>` : '';
      const gap = (node.left && node.right) ? `<div class="w-2 md:w-6"></div>` : '';

      return `
        <div class="flex flex-col items-center mx-1 relative">
          <div class="rounded-full border flex items-center justify-center shadow-md z-10 relative ${nodeSize} ${nodeColor}">
            ${centerIconOrText}
            ${badge}
          </div>
          ${rootTag}
          <div class="flex items-start justify-center pt-2 relative">
            ${connectors}
            <div class="flex flex-col items-center">
              ${leftLine}
              ${renderTreeNode(node.left, level+1, maxDepth)}
            </div>
            ${gap}
            <div class="flex flex-col items-center">
              ${rightLine}
              ${renderTreeNode(node.right, level+1, maxDepth)}
            </div>
          </div>
        </div>
      `;
    }

    // -----------------------------
    // Marketplace helpers
    // -----------------------------
    function uniqLocations() {
      const locs = new Set(['All']);
      MOCK_PRINTERS.forEach(p => locs.add((p.location || 'Unknown').split(',')[0].trim()));
      return Array.from(locs);
    }

    function filteredPrinters() {
      const q = (state.mp.search || '').trim().toLowerCase();
      const cat = state.mp.category || 'All';
      const loc = state.mp.location || 'All';

      let arr = MOCK_PRINTERS.slice();

      if (q) {
        arr = arr.filter(p => {
          const blob = `${p.name} ${p.handle} ${p.location} ${(p.services||[]).join(' ')}`.toLowerCase();
          return blob.includes(q);
        });
      }
      if (cat !== 'All') {
        arr = arr.filter(p => (p.services||[]).includes(cat) || (p.priceList||[]).some(i => i.category === cat));
      }
      if (loc !== 'All') {
        arr = arr.filter(p => ((p.location||'').split(',')[0].trim()) === loc);
      }

      const sort = state.mp.sort || 'Recommended';
      if (sort === 'Rating') arr.sort((a,b)=> (b.rating||0)-(a.rating||0));
      else if (sort === 'Fastest') arr.sort((a,b)=> (a.responseMins||999)-(b.responseMins||999));
      else if (sort === 'PriceLow') {
        const minPrice = (p) => Math.min(...(p.priceList||[]).map(x=>x.price||Infinity));
        arr.sort((a,b)=> minPrice(a)-minPrice(b));
      } else {
        arr.sort((a,b)=> {
          const sa = (a.verified?50:0) + (a.rating||0)*10 + (50 - Math.min(50,a.responseMins||50));
          const sb = (b.verified?50:0) + (b.rating||0)*10 + (50 - Math.min(50,b.responseMins||50));
          return sb - sa;
        });
      }
      return arr;
    }

    function printerAvatar(printer) {
      const letter = (printer.name || 'P').substring(0,1).toUpperCase();
      const bg = printer.verified ? 'bg-blue-600' : 'bg-gray-900';
      return `
        <div class="w-10 h-10 rounded-full ${bg} text-white flex items-center justify-center font-black shadow-sm">
          ${letter}
        </div>
      `;
    }

    function storyBubble(printer) {
      const ring = printer.verified ? 'from-blue-500 to-purple-500' : 'from-gray-700 to-gray-500';
      return `
        <button data-open-printer="${printer.id}" class="flex flex-col items-center gap-1">
          <div class="p-[2px] rounded-full bg-gradient-to-br ${ring}">
            <div class="bg-white rounded-full p-[2px]">
              <div class="w-14 h-14 rounded-full overflow-hidden bg-gray-100">
                <img class="w-full h-full object-cover" src="${svgThumb(printer.handle, false)}" alt="${printer.name}"/>
              </div>
            </div>
          </div>
          <span class="text-[10px] font-bold text-gray-600 max-w-[72px] truncate">${printer.handle.replace('@','')}</span>
        </button>
      `;
    }

    function pricePill(item) {
      return `
        <span class="inline-flex items-center gap-1 text-xs font-black bg-green-50 text-green-700 border border-green-100 px-2 py-0.5 rounded-full">
          â‚¦${fmt(item.price)} <span class="text-[10px] font-bold text-green-800/70">${item.unit}</span>
        </span>
      `;
    }

    function followText(pid) { return state.mp.following[pid] ? 'Following' : 'Follow'; }
    function followClasses(pid) {
      return state.mp.following[pid]
        ? 'bg-gray-900 text-white hover:bg-black'
        : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-green-200';
    }

    function openPrinterProfile(printerId) { state.mp.openPrinterId = printerId; render(); }
    function closePrinterProfile() { state.mp.openPrinterId = null; render(); }

    function startInvoiceFromItem(printerId, sku) {
      const printer = MOCK_PRINTERS.find(p => p.id === printerId);
      if (!printer) return;
      const item = (printer.priceList||[]).find(i => i.sku === sku);
      if (!item) return;

      state.jobDraft = {
        businessId: printer.businessId,
        jobTitle: `${item.name} â€” ${printer.name}`,
        jobType: item.category === 'Banners' ? 'Flex Banner (Large)'
              : item.category === 'Flyers' ? 'Flyers (1000pcs)'
              : item.category === 'Stickers' ? 'SAV Sticker'
              : item.category === 'Branding' ? 'Vehicle Branding'
              : item.category === 'Stationery' ? 'Business Cards'
              : item.category === 'Apparel' ? 'T-Shirt Heat Transfer'
              : item.category === 'Embroidery' ? 'Monogram / Embroidery'
              : 'Custom',
        costPrice: item.suggestedCost || Math.max(0, Math.round(item.price * 0.9)),
        margin: Math.max(500, Math.round((item.price - (item.suggestedCost||0)) || 1500))
      };

      state.mp.openPrinterId = null;
      state.view = 'new-job';
      render();
    }

    // -----------------------------
    // Upgrade flow
    // -----------------------------
    function selectUpgradeTier(t) { state.upgrade.selectedTier = t; state.upgrade.paid = false; render(); }
    function markUpgradePaid() { if (!state.upgrade.selectedTier) return; state.upgrade.paid = true; render(); }
    function finalizeUpgrade() {
      const t = state.upgrade.selectedTier;
      if (!t) return;
      if (!state.upgrade.paid) { toast('error', 'Mark payment as done first.'); return; }
      state.userData = { ...state.userData, membershipTier: t };
      toast('success', `Upgraded to ${TIERS[t].name}.`);
      state.view = 'dashboard';
      render();
    }

    // -----------------------------
    // Render: Shared UI
    // -----------------------------
    function renderFlash() {
      if (!state.flashMsg) return '';
      const msg = state.flashMsg;
      const cls = msg.type === 'error'
        ? 'bg-red-50 text-red-700 border-red-100'
        : 'bg-green-50 text-green-700 border-green-100';
      const ic = msg.type === 'error' ? 'alert-triangle' : 'check-circle';
      return `
        <div class="fixed top-14 left-1/2 -translate-x-1/2 z-[60] w-[92%] max-w-xl animate-pop">
          <div class="border ${cls} rounded-2xl p-3 flex items-start gap-2 shadow-lg">
            <div class="mt-0.5">${icon(ic,'w-5 h-5')}</div>
            <div class="text-sm font-bold">${msg.text}</div>
          </div>
        </div>
      `;
    }

    function renderTopNav() {
      const t = tier();

      const navPill = (v, label, ic) => {
        const active = state.view === v ? 'bg-green-50 text-green-700 border-green-100' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50';
        return `
          <button data-nav="${v}" class="hidden md:flex items-center gap-2 px-3 py-2 rounded-xl border ${active} font-black text-sm">
            ${icon(ic,'w-4 h-4')} ${label}
          </button>
        `;
      };

      return `
        <div class="bg-white shadow-sm sticky top-0 z-40 px-4 py-3 border-b border-gray-100">
          <div class="max-w-6xl mx-auto flex justify-between items-center gap-3">
            <div class="flex items-center gap-3">
              <button data-nav="dashboard" class="flex items-center gap-2">
                <div class="bg-green-600 p-1.5 rounded-lg">
                  ${icon('printer','text-white w-5 h-5')}
                </div>
                <span class="font-black text-gray-800 text-lg hidden sm:block">YesPrint</span>
              </button>

              <div class="hidden md:flex items-center gap-2 ml-3">
                ${navPill('dashboard','Home','home')}
                ${navPill('marketplace','Marketplace','store')}
                ${navPill('new-job','Submit','plus-circle')}
                ${navPill('network','Network','users')}
                ${navPill('wallet','Wallet','wallet')}
                ${navPill('upgrade','Upgrade','sparkles')}
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex md:hidden items-center gap-2">
                <button data-nav="marketplace" class="flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 font-black text-sm">
                  ${icon('store','w-4 h-4')} Market
                </button>
                <button data-nav="upgrade" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black font-black text-sm">
                  ${icon('sparkles','w-4 h-4')} Upgrade
                </button>
              </div>

              <div class="hidden sm:flex flex-col items-end mr-1">
                <span class="text-sm font-black text-gray-800">${state.userData?.fullName || ''}</span>
                <div class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full ${t.theme.dot}"></span>
                  <span class="text-xs text-gray-500 uppercase">${state.userData?.membershipTier || ''}</span>
                </div>
              </div>

              <button data-nav="wallet" class="bg-green-50 text-green-700 border border-green-100 px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2">
                ${icon('wallet','w-4 h-4')}
                â‚¦${fmt(state.userData?.walletBalance)}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderBottomNav() {
      if (!['dashboard','new-job','network','wallet','payment-success','marketplace','upgrade'].includes(state.view)) return '';
      const active = (v) => state.view === v ? 'text-green-700 bg-green-50 scale-105' : 'text-gray-500 hover:bg-gray-50';
      return `
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 md:hidden grid grid-cols-5 gap-1 z-50 pb-safe">
          <button data-nav="dashboard" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${active('dashboard')}">
            ${icon('home','w-6 h-6')} <span class="text-[10px] font-black mt-1">Home</span>
          </button>
          <button data-nav="marketplace" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${active('marketplace')}">
            ${icon('store','w-6 h-6')} <span class="text-[10px] font-black mt-1">Market</span>
          </button>
          <button data-nav="new-job" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${active('new-job')}">
            ${icon('plus-circle','w-6 h-6')} <span class="text-[10px] font-black mt-1">Submit</span>
          </button>
          <button data-nav="network" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${active('network')}">
            ${icon('users','w-6 h-6')} <span class="text-[10px] font-black mt-1">Network</span>
          </button>
          <button data-nav="wallet" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${active('wallet')}">
            ${icon('wallet','w-6 h-6')} <span class="text-[10px] font-black mt-1">Wallet</span>
          </button>
        </div>
      `;
    }

    // -----------------------------
    // Pages
    // -----------------------------
    function renderLanding() {
      return `
        <div class="min-h-screen bg-white font-sans text-gray-900 overflow-x-hidden">
          <header class="sticky top-0 bg-white/90 backdrop-blur-md z-40 border-b border-gray-100">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
              <div class="flex items-center gap-2">
                <div class="bg-green-600 p-1.5 rounded-lg">
                  ${icon('printer', 'text-white w-5 h-5')}
                </div>
                <span class="font-black text-xl tracking-tight">YesPrint</span>
              </div>
              <div class="flex gap-3">
                <button id="btnLogin" class="text-sm font-black text-gray-600 hover:text-green-600">Log In</button>
                <button id="btnJoin" class="bg-black text-white px-4 py-2 rounded-lg text-sm font-black hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200">Join</button>
              </div>
            </div>
          </header>

          <section class="pt-16 pb-20 px-4 max-w-5xl mx-auto text-center relative">
            <div class="absolute top-0 left-10 w-20 h-20 bg-yellow-400 rounded-full blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute bottom-0 right-10 w-32 h-32 bg-green-400 rounded-full blur-3xl opacity-20"></div>

            <div class="inline-flex items-center gap-2 bg-red-50 text-red-600 px-4 py-1.5 rounded-full text-sm font-black mb-6 border border-red-100 animate-bounce">
              ${icon('zap', 'w-4 h-4')}
              <span>Limited slots this month</span>
            </div>

            <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight text-gray-900 mb-6 leading-tight">
              Printing Marketplace <br/> with Agent Earnings.
            </h1>
            <p class="text-xl text-gray-500 mb-10 max-w-2xl mx-auto">
              Find verified printers, see price lists, and generate a downloadable invoice instantly.
            </p>

            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
              ${Button(`Get Started ${icon('arrow-right','w-6 h-6')}`, { variant:'cta', id:'btnStart', className:'w-full sm:w-auto px-10 py-5 text-xl' })}
            </div>
            <p class="mt-4 text-xs text-gray-400">Built for Nigeria. Fast, simple, clean.</p>
          </section>

          <section class="bg-gray-900 text-white py-16">
            <div class="max-w-6xl mx-auto px-4">
              <div class="grid md:grid-cols-3 gap-8 text-center">
                <div class="p-6 border border-gray-800 rounded-2xl">
                  <h3 class="text-4xl font-black text-green-400 mb-2">â‚¦150M+</h3>
                  <p class="text-gray-400">Payouts processed</p>
                </div>
                <div class="p-6 border border-gray-800 rounded-2xl">
                  <h3 class="text-4xl font-black text-blue-400 mb-2">Verified</h3>
                  <p class="text-gray-400">Printer profiles + prices</p>
                </div>
                <div class="p-6 border border-gray-800 rounded-2xl">
                  <h3 class="text-4xl font-black text-yellow-400 mb-2">PNG</h3>
                  <p class="text-gray-400">Download invoice</p>
                </div>
              </div>
            </div>
          </section>

          <section class="py-20 px-4 max-w-6xl mx-auto">
            <h2 class="text-3xl font-black text-center mb-4">Plans</h2>
            <p class="text-center text-gray-500 mb-12">Upgrade anytime to unlock deeper network levels.</p>

            <div class="grid md:grid-cols-4 gap-6">
              <div class="border border-gray-200 rounded-2xl p-6 hover:shadow-xl transition-shadow relative">
                <h3 class="text-xl font-black text-gray-800">Standard</h3>
                <p class="text-3xl font-extrabold mt-2">Free</p>
                <p class="text-sm text-gray-400 mb-6">Forever</p>
                <ul class="space-y-3 mb-0 text-sm">
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-green-500')} Network depth: <b>2</b></li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-green-500')} Marketplace access</li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-green-500')} Invoice PNG download</li>
                </ul>
              </div>

              <div class="border border-blue-200 bg-blue-50 rounded-2xl p-6 hover:shadow-xl transition-shadow relative transform md:-translate-y-4">
                <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-bl-lg font-black">POPULAR</div>
                <h3 class="text-xl font-black text-blue-800">Silver</h3>
                <p class="text-3xl font-extrabold mt-2 text-blue-900">â‚¦5,000</p>
                <p class="text-sm text-blue-600 mb-6">/ month</p>
                <ul class="space-y-3 mb-0 text-sm">
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-blue-600')} Network depth: <b>3</b></li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-blue-600')} Better placement</li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-blue-600')} Priority support</li>
                </ul>
              </div>

              <div class="border border-yellow-200 bg-yellow-50 rounded-2xl p-6 hover:shadow-xl transition-shadow relative">
                <h3 class="text-xl font-black text-yellow-800">Gold</h3>
                <p class="text-3xl font-extrabold mt-2 text-yellow-900">â‚¦20,000</p>
                <p class="text-sm text-yellow-600 mb-6">/ month</p>
                <ul class="space-y-3 mb-0 text-sm">
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-yellow-600')} Network depth: <b>5</b></li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-yellow-600')} Dedicated manager</li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-yellow-600')} Bulk job tools</li>
                </ul>
              </div>

              <div class="border border-purple-200 bg-purple-50 rounded-2xl p-6 hover:shadow-xl transition-shadow relative">
                <h3 class="text-xl font-black text-purple-800 flex items-center gap-2">${icon('gem','w-4 h-4')} Diamond</h3>
                <p class="text-3xl font-extrabold mt-2 text-purple-900">â‚¦100,000</p>
                <p class="text-sm text-purple-600 mb-6">/ month</p>
                <ul class="space-y-3 mb-0 text-sm">
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-purple-600')} Network depth: <b>9</b></li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-purple-600')} VIP placement</li>
                  <li class="flex gap-2">${icon('check-circle','w-4 h-4 text-purple-600')} Lower network unlock target</li>
                </ul>
              </div>
            </div>
          </section>

          <footer class="bg-gray-50 border-t border-gray-200 py-10 text-center text-gray-500 text-sm">
            <p>Â© 2025 YesPrint Digital.</p>
          </footer>
        </div>
      `;
    }

    function renderAuth() {
      const title = state.isRegistering ? 'Create Account' : 'Log In';
      return `
        <div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 relative">
          <button id="btnBackToHome"
            class="absolute top-4 left-4 text-gray-400 hover:text-gray-600 flex items-center gap-1 text-sm font-black">
            ${icon('chevron-right','w-4 h-4 rotate-180')} Back
          </button>

          <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md animate-fade-in-up my-10">
            <div class="text-center mb-6">
              <h1 class="text-2xl font-black text-gray-800">${title}</h1>
              <p class="text-xs text-gray-400 mt-2">Secure login â€¢ Fast setup</p>
            </div>

            <form id="authForm" class="space-y-3">
              ${
                state.isRegistering ? `
                  <input name="fullName" type="text" required placeholder="Full Name"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                  <input name="phone" type="tel" required placeholder="Phone Number"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                  <div class="grid grid-cols-2 gap-2">
                    <input name="bankName" type="text" required placeholder="Bank Name"
                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                    <input name="accountNumber" type="text" required placeholder="Account No"
                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <input name="pin" type="password" required maxlength="4" placeholder="4-Digit PIN"
                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                    <input name="referralCode" type="text" required placeholder="Referral Code"
                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                  <input name="email" type="email" placeholder="Email (Optional)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                ` : `
                  <input name="email" type="email" required placeholder="Email Address"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                `
              }

              <input name="password" type="password" required placeholder="${state.isRegistering ? 'Create Password' : 'Password'}"
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />

              ${Button(state.loading ? 'Please wait...' : (state.isRegistering ? 'Create Account' : 'Log In'), {
                variant: 'primary',
                type: 'submit',
                disabled: state.loading,
                className: 'w-full shadow-lg shadow-green-200'
              })}
            </form>

            <div class="mt-4 text-center">
              <button id="btnToggleAuth" class="text-green-600 font-black text-sm">
                ${state.isRegistering ? 'Already have an account? Log in' : 'New here? Create an account'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderDashboard() {
      const t = tier();
      const themeBar = `${t.theme.bg} ${t.theme.border}`;
      const themeText = `${t.theme.text}`;
      const jobs = state.jobs || [];

      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="space-y-6 animate-fade-in">

              <div class="${themeBar} border p-4 rounded-2xl flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                  <p class="${themeText} font-black text-sm uppercase flex items-center gap-2">
                    ${icon('award','w-4 h-4')} Plan: ${t.name}
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    Network depth: <b>${t.depth}</b> â€¢ Network withdrawals unlock at <b>${jobsNeededToUnlockNetworkWithdraw()} jobs/month</b>.
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <button data-nav="upgrade" class="text-xs bg-black text-white px-3 py-2 rounded-xl font-black hover:bg-gray-800 flex items-center gap-2">
                    ${icon('sparkles','w-4 h-4')} Upgrade
                  </button>
                  <button data-nav="marketplace" class="text-xs bg-white border border-gray-200 px-3 py-2 rounded-xl font-black hover:bg-gray-50 flex items-center gap-2">
                    ${icon('store','w-4 h-4')} Marketplace
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${Card(`
                  <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                  <div class="relative z-10">
                    <p class="text-gray-400 text-xs uppercase tracking-wider font-black mb-1">Wallet</p>
                    <h2 class="text-4xl font-extrabold">â‚¦${fmt(state.userData?.walletBalance)}</h2>
                    <div class="mt-4 grid grid-cols-2 gap-2">
                      <div class="bg-white/10 px-3 py-2 rounded-xl">
                        <p class="text-[10px] text-white/70 font-black uppercase">Direct</p>
                        <p class="text-sm font-extrabold">â‚¦${fmt(state.userData?.jobProfits)}</p>
                      </div>
                      <div class="bg-white/10 px-3 py-2 rounded-xl">
                        <p class="text-[10px] text-white/70 font-black uppercase">Network</p>
                        <p class="text-sm font-extrabold">â‚¦${fmt(state.userData?.networkEarnings)}</p>
                      </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                      <button data-nav="wallet" class="bg-white/10 hover:bg-white/15 border border-white/10 px-3 py-2 rounded-xl text-xs font-black flex items-center gap-2">
                        ${icon('wallet','w-4 h-4')} Wallet
                      </button>
                      <button data-nav="new-job" class="bg-white text-gray-900 hover:bg-gray-100 px-3 py-2 rounded-xl text-xs font-black flex items-center gap-2">
                        ${icon('plus-circle','w-4 h-4')} Submit
                      </button>
                    </div>
                  </div>
                `, 'bg-gradient-to-br from-gray-900 to-gray-800 text-white border-none relative overflow-hidden')}

                <div class="grid grid-cols-2 gap-4">
                  ${Card(`
                    <div class="p-2 bg-blue-50 rounded-lg inline-flex">${icon('git-merge','text-blue-600 w-5 h-5')}</div>
                    <div class="mt-2">
                      <p class="text-2xl font-extrabold text-gray-800">${state.userData?.networkCount || 0}</p>
                      <p class="text-gray-500 text-xs font-black uppercase">Team</p>
                    </div>
                  `, 'p-4 flex flex-col justify-between')}

                  ${Card(`
                    <div class="p-2 bg-orange-50 rounded-lg inline-flex">${icon('briefcase','text-orange-600 w-5 h-5')}</div>
                    <div class="mt-2">
                      <p class="text-2xl font-extrabold text-gray-800">${state.userData?.jobsThisMonth || 0} <span class="text-xs text-gray-400 font-black">/ ${jobsNeededToUnlockNetworkWithdraw()}</span></p>
                      <p class="text-gray-500 text-xs font-black uppercase">Jobs this month</p>
                    </div>
                  `, 'p-4 flex flex-col justify-between')}
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                ${Button(`${icon('store','w-6 h-6')} Marketplace`, { dataNav:'marketplace', className:'py-4 text-lg shadow-lg shadow-green-100' })}
                ${Button(`${icon('plus-circle','w-6 h-6')} Submit Job`, { dataNav:'new-job', className:'py-4 text-lg shadow-lg shadow-green-100', variant:'primary' })}
                ${Button(`${icon('users','w-6 h-6')} Network`, { variant:'secondary', dataNav:'network', className:'py-4 text-lg' })}
              </div>

              <div>
                <h3 class="font-black text-gray-800 mb-4">Recent Jobs</h3>
                <div class="space-y-3">
                  ${jobs.length === 0 ? `<p class="text-gray-400 text-sm text-center py-8">No jobs yet.</p>` : ''}
                  ${jobs.slice(0,5).map(job => {
                    const isPending = job.status === 'Pending';
                    return `
                      <div class="bg-white p-4 rounded-2xl border border-gray-100 flex flex-col sm:flex-row justify-between items-center shadow-sm gap-4">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                          <div class="p-3 rounded-xl ${isPending ? 'bg-yellow-100' : 'bg-green-100'}">
                            ${isPending ? icon('clock','w-5 h-5 text-yellow-600') : icon('check-circle','w-5 h-5 text-green-600')}
                          </div>
                          <div>
                            <p class="font-black text-gray-800">${job.jobTitle}</p>
                            <p class="text-xs text-gray-500">${job.businessName} â€¢ ${job.status}</p>
                          </div>
                        </div>

                        <div class="flex items-center gap-3 w-full sm:w-auto justify-end">
                          <div class="text-right">
                            <p class="font-extrabold text-gray-800">â‚¦${fmt(job.amount)}</p>
                            ${!isPending ? `
                              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-black bg-green-100 text-green-800">
                                + â‚¦${fmt(job.agentProfit)}
                              </span>` : ''
                            }
                          </div>

                          ${
                            isPending ? `
                              <div class="flex gap-2">
                                <button data-open-invoice="${job.id}"
                                  class="bg-gray-100 text-gray-700 px-3 py-2 rounded-xl text-xs font-black hover:bg-gray-200">
                                  Invoice
                                </button>
                                <button data-confirm-job="${job.id}"
                                  class="bg-green-600 text-white px-3 py-2 rounded-xl text-xs font-black hover:bg-green-700 shadow-sm">
                                  Confirm
                                </button>
                              </div>
                            ` : `
                              <button data-open-invoice="${job.id}" class="text-gray-400 hover:text-gray-700">
                                ${icon('file-text','w-5 h-5')}
                              </button>
                            `
                          }
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    function renderNewJob() {
      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in max-w-2xl mx-auto">
              <div class="flex items-center justify-between gap-2 mb-6">
                <div class="flex items-center gap-2">
                  <button data-nav="dashboard" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    ${icon('chevron-right','w-5 h-5 rotate-180')}
                  </button>
                  <h2 class="text-xl font-black text-gray-800">New Job</h2>
                </div>
                <button data-nav="marketplace" class="text-xs font-black px-3 py-2 rounded-xl border border-gray-200 hover:bg-gray-50 flex items-center gap-2">
                  ${icon('store','w-4 h-4')} Marketplace
                </button>
              </div>

              ${state.jobDraft ? `
                <div class="mb-4 bg-blue-50 border border-blue-100 text-blue-800 p-4 rounded-2xl flex items-start gap-3">
                  <div class="mt-0.5">${icon('sparkles','w-5 h-5')}</div>
                  <div>
                    <p class="font-black text-sm">Draft loaded from Marketplace</p>
                    <p class="text-xs text-blue-700/80 mt-1">Edit if needed, then generate invoice.</p>
                  </div>
                </div>
              ` : ''}

              ${Card(`
                <form id="jobForm" class="space-y-6">
                  <div>
                    <label class="block text-sm font-black text-gray-700 mb-2">Printing Business</label>
                    <select name="businessId" required class="w-full px-4 py-3 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none bg-white">
                      <option value="">-- Choose Business --</option>
                      ${MOCK_BUSINESSES.map(b => `<option value="${b.id}">${b.name} (${b.location})</option>`).join('')}
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm font-black text-gray-700 mb-2">Job Description</label>
                    <input name="jobTitle" required type="text" placeholder="e.g. Church banner for Sunday"
                      class="w-full px-4 py-3 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>

                  <div>
                    <label class="block text-sm font-black text-gray-700 mb-2">Category</label>
                    <select id="jobTypeSelect" name="jobType" required class="w-full px-4 py-3 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none bg-white">
                      ${JOB_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>

                    <div id="customTypeWrap" class="mt-3 hidden">
                      <label class="block text-xs font-black text-gray-600 mb-2 uppercase">Custom Category</label>
                      <input name="customJobType" type="text" placeholder="e.g. PVC ID Cards, Souvenir, Wall branding..."
                        class="w-full px-4 py-3 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none" />
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-2xl border border-gray-200">
                    <div>
                      <label class="block text-xs font-black text-gray-500 mb-1 uppercase">Printer Cost</label>
                      <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400">â‚¦</span>
                        <input name="costPrice" required type="number" placeholder="0"
                          class="w-full pl-6 pr-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs font-black text-green-600 mb-1 uppercase">Your Profit</label>
                      <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400">â‚¦</span>
                        <input name="margin" required type="number" placeholder="0"
                          class="w-full pl-6 pr-3 py-2 border border-green-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" />
                      </div>
                    </div>
                  </div>

                  ${Button(`${icon('download','w-5 h-5')} Generate Invoice (PNG)`, { type:'submit', className:'w-full py-4 text-lg shadow-xl shadow-green-100' })}
                </form>
              `, 'border-t-4 border-t-green-500')}
            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    function renderPaymentSuccess() {
      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}
          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in max-w-md mx-auto text-center pt-10">
              <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                ${icon('check-circle','w-12 h-12 text-green-600')}
              </div>
              <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Payment Confirmed</h2>
              <p class="text-gray-600 mb-8">Your profit has been credited.</p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                ${Button('Dashboard', { dataNav:'dashboard' })}
                ${Button(`${icon('store','w-4 h-4')} Marketplace`, { dataNav:'marketplace', variant:'secondary' })}
              </div>
            </div>
          </div>
          ${renderBottomNav()}
        </div>
      `;
    }
function renderUpgradeForMoreMoneyCard() {
  const currentKey = state.userData?.membershipTier || 'standard';

  // numbers match your text:
  // Standard depth 2 => 6 people
  // Diamond depth 9 => 1,022 people
  const standardPeople = peopleUnderUser(TIERS.standard.depth);
  const diamondPeople  = peopleUnderUser(TIERS.diamond.depth);

  const dailyStandard = standardPeople * AVG_COMMISSION_PER_JOB;     // 6 * 20 = 120
  const dailyDiamond  = diamondPeople  * AVG_COMMISSION_PER_JOB;     // 1022 * 20 = 20,440
  const monthlyDiamond = dailyDiamond * 30;                          // 613,200

  return `
    <div class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="text-lg font-extrabold text-gray-900">Upgrade for more money</h3>
          <p class="text-sm text-gray-600 mt-1 font-black leading-relaxed">
            In Standard you only get commission from <b>${fmt(standardPeople)}</b> people. In Diamond your commission is from <b>${fmt(diamondPeople)}</b> people.
          </p>
          <p class="text-sm text-gray-600 mt-2 font-black leading-relaxed">
            At average of <b>â‚¦${fmt(AVG_COMMISSION_PER_JOB)}</b> per job, thatâ€™s <b>â‚¦${fmt(dailyDiamond)}</b> daily, over <b>â‚¦${fmt(monthlyDiamond)}</b> monthly.
          </p>
          <p class="text-xs text-gray-500 mt-2 font-black">
            (Assumes 1 job/day per person. Even if only 10% are active daily, itâ€™s still scary money.)
          </p>
        </div>

        <div class="shrink-0 bg-gray-900 text-white px-3 py-2 rounded-xl text-xs font-extrabold flex items-center gap-2">
          ${icon('sparkles','w-4 h-4')} Upgrade
        </div>
      </div>

      <div class="mt-5 grid sm:grid-cols-2 gap-3">
        <div class="border border-gray-200 rounded-2xl p-4 bg-gray-50">
          <p class="text-xs text-gray-500 font-black uppercase">Your Plan</p>
          <p class="text-xl font-extrabold text-gray-900 mt-1">${TIERS[currentKey].name}</p>
          <p class="text-sm text-gray-700 font-black mt-2">${fmt(standardPeople)} people</p>
          <p class="text-sm text-gray-900 font-extrabold mt-1">â‰ˆ â‚¦${fmt(dailyStandard)}/day</p>
        </div>

        <div class="border border-green-200 rounded-2xl p-4 bg-green-50">
          <p class="text-xs text-green-700 font-black uppercase">If You Go Diamond</p>
          <p class="text-xl font-extrabold text-gray-900 mt-1">${TIERS.diamond.name}</p>
          <p class="text-sm text-gray-700 font-black mt-2">${fmt(diamondPeople)} people</p>
          <p class="text-sm text-gray-900 font-extrabold mt-1">â‰ˆ â‚¦${fmt(dailyDiamond)}/day</p>
        </div>
      </div>

      <div class="mt-5 flex flex-col sm:flex-row gap-3">
        <button data-nav="upgrade"
          class="w-full sm:w-auto px-5 py-3 rounded-xl bg-green-600 text-white font-extrabold hover:bg-green-700 flex items-center justify-center gap-2">
          ${icon('unlock','w-4 h-4')} Unlock More People
        </button>
        <button data-nav="upgrade"
          class="w-full sm:w-auto px-5 py-3 rounded-xl bg-gray-900 text-white font-extrabold hover:bg-black flex items-center justify-center gap-2">
          ${icon('sparkles','w-4 h-4')} Upgrade Now
        </button>
      </div>
    </div>
  `;
}

    function renderNetwork() {
      const t = tier();
      const treeHtml = renderTreeNode(state.binaryTree, 0, t.depth);

      const nodes = flattenTree(state.binaryTree || null, []);
      const unlocked = nodes.filter(n => (n.level || 0) > 0 && (n.level || 0) <= t.depth);

      const current = potentialEarningsFromDepth(t.depth);
      const diamond = potentialEarningsFromDepth(TIERS.diamond.depth);

      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in space-y-6">
              <div class="flex items-center gap-2">
                <button data-nav="dashboard" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                  ${icon('chevron-right','w-5 h-5 rotate-180')}
                </button>
                <h2 class="text-xl font-black text-gray-800">Network</h2>
              </div>

              ${Card(`
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div>
                    <p class="text-blue-100 text-sm mb-1 font-black">Unlocked depth</p>
                    <h1 class="text-4xl font-extrabold mb-1">${t.depth} levels</h1>
                    <p class="text-xs text-blue-200 font-black">Plan: ${t.name}</p>
                  </div>
                  <div class="bg-white/10 border border-white/10 rounded-2xl p-4">
                    <p class="text-xs text-white/70 font-black uppercase">Visible members</p>
                    <p class="text-3xl font-extrabold">${fmt(unlocked.length)}</p>
                    <p class="text-xs text-white/70 font-black mt-1">Upgrade to unlock more levels</p>
                  </div>
                </div>

                <div class="mt-4 grid sm:grid-cols-2 gap-3">
                  <div class="bg-white/10 border border-white/10 rounded-2xl p-4">
                    <p class="text-xs text-white/70 font-black uppercase">This plan</p>
                    <p class="text-lg font-extrabold">${fmt(current.people)} people</p>
                    <p class="text-xs text-white/70 font-black mt-1">â‰ˆ â‚¦${fmt(current.daily)}/day</p>
                  </div>
                  <div class="bg-white/10 border border-white/10 rounded-2xl p-4">
                    <p class="text-xs text-white/70 font-black uppercase">Diamond</p>
                    <p class="text-lg font-extrabold">${fmt(diamond.people)} people</p>
                    <p class="text-xs text-white/70 font-black mt-1">â‰ˆ â‚¦${fmt(diamond.daily)}/day</p>
                  </div>
                </div>

                <div class="mt-4">
                  <button data-nav="upgrade" class="w-full md:w-auto px-5 py-3 rounded-xl bg-white text-gray-900 font-extrabold hover:bg-gray-100 flex items-center justify-center gap-2">
                    ${icon('sparkles','w-4 h-4')} Upgrade
                  </button>
                </div>
              `, 'bg-gradient-to-r from-blue-600 to-blue-500 text-white border-none rounded-2xl')}
${renderUpgradeForMoreMoneyCard()}

              <div class="bg-gray-50 rounded-2xl border border-gray-200 p-2 overflow-auto min-h-[420px] flex justify-center relative shadow-inner">
                <div class="min-w-[720px] flex justify-center pt-4">
                  ${treeHtml}
                </div>
              </div>

              ${Card(`
                <div class="flex items-center justify-between gap-3 mb-3">
                  <h3 class="font-extrabold text-gray-900">Members (within your plan)</h3>
                  <span class="text-xs font-black text-gray-500">${fmt(unlocked.length)}</span>
                </div>
                <div class="grid sm:grid-cols-2 gap-3 max-h-[420px] overflow-auto pr-1">
                  ${unlocked.slice(0, 60).map(n => `
                    <div class="border border-gray-200 rounded-2xl p-4 bg-white flex items-center justify-between gap-3">
                      <div class="min-w-0">
                        <p class="font-extrabold text-gray-900 truncate">${n.name}</p>
                        <p class="text-xs text-gray-500 font-black">Level ${n.level} â€¢ <span class="font-mono">${n.id}</span></p>
                      </div>
                      <div class="text-right">
                        <p class="text-xs text-gray-500 font-black uppercase">Sales</p>
                        <p class="font-extrabold text-gray-900">â‚¦${fmt(n.sales)}</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `)}

            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    function renderWallet() {
      const jobsThisMonth = state.userData?.jobsThisMonth || 0;
      const req = jobsNeededToUnlockNetworkWithdraw();
      const unlocked = isNetworkWithdrawUnlocked();

      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in">
              <div class="flex items-center gap-2 mb-6">
                <button data-nav="dashboard" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                  ${icon('chevron-right','w-5 h-5 rotate-180')}
                </button>
                <h2 class="text-xl font-black text-gray-800">Wallet</h2>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                ${Card(`
                  <p class="text-gray-500 text-xs uppercase font-black">Total</p>
                  <p class="text-2xl font-extrabold text-gray-900 mt-1">â‚¦${fmt(state.userData?.walletBalance)}</p>
                  <p class="text-[11px] text-gray-400 font-black mt-2">Direct + Network</p>
                `)}

                ${Card(`
                  <p class="text-gray-500 text-xs uppercase font-black">Direct Profit</p>
                  <p class="text-2xl font-extrabold text-gray-900 mt-1">â‚¦${fmt(state.userData?.jobProfits)}</p>
                  <p class="text-[11px] text-gray-400 font-black mt-2">Withdraw anytime</p>
                `, 'border-l-4 border-l-blue-500')}

                ${Card(`
                  <p class="text-gray-500 text-xs uppercase font-black">Network Earnings</p>
                  <p class="text-2xl font-extrabold text-gray-900 mt-1">â‚¦${fmt(state.userData?.networkEarnings)}</p>
                  <p class="text-[11px] ${unlocked ? 'text-green-700' : 'text-gray-400'} font-black mt-2">
                    ${unlocked ? 'Unlocked' : 'Locked'}
                  </p>
                `, 'border-l-4 border-l-green-500')}
              </div>

              ${Card(`
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                  <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex-1">
                    <p class="text-xs text-gray-500 font-black uppercase">Payout account</p>
                    <p class="font-extrabold text-gray-900 mt-1">${state.userData?.bankName || ''} â€¢ ${state.userData?.accountNumber || ''}</p>

                    <div class="mt-4 p-4 rounded-2xl border ${unlocked ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-white'}">
                      <p class="text-xs font-black uppercase ${unlocked ? 'text-green-700' : 'text-gray-600'}">Network withdrawal rule</p>
                      <p class="text-sm font-extrabold text-gray-900 mt-1">${jobsThisMonth}/${req} jobs this month</p>
                      <div class="w-full bg-gray-200 h-1.5 rounded-full mt-3 overflow-hidden">
                        <div class="bg-green-500 h-1.5 rounded-full" style="width:${Math.min(100,(jobsThisMonth/req)*100)}%"></div>
                      </div>
                      <p class="text-[11px] text-gray-500 font-black mt-2">
                        Standard 8 â€¢ Silver 10 â€¢ Gold 12 â€¢ Diamond 6
                      </p>
                    </div>
                  </div>

                  <div class="flex-1 space-y-3">
                    ${Button(`${icon('banknote','w-5 h-5')} Withdraw Direct Profit`, {
                      dataAction:'withdraw-direct',
                      className:'w-full'
                    })}
                    ${Button(`${icon('git-merge','w-5 h-5')} Withdraw Network Earnings`, {
                      dataAction:'withdraw-network',
                      className:'w-full',
                      variant: unlocked ? 'primary' : 'secondary',
                      disabled: !unlocked
                    })}
                    <button data-nav="upgrade" class="w-full px-6 py-3 rounded-xl border border-gray-200 hover:bg-gray-50 font-extrabold flex items-center justify-center gap-2">
                      ${icon('sparkles','w-4 h-4')} Upgrade
                    </button>
                  </div>
                </div>
              `)}
            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    function renderMarketplace() {
      const printers = filteredPrinters();
      const locs = uniqLocations();
      const isGrid = state.mp.viewType === 'grid';

      const viewBtn = (type, label, ic) => {
        const active = state.mp.viewType === type ? 'bg-gray-900 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50';
        return `
          <button data-mp-view="${type}" class="${active} px-3 py-2 rounded-xl text-xs font-extrabold flex items-center gap-2">
            ${icon(ic,'w-4 h-4')} ${label}
          </button>
        `;
      };

      const listCard = (p) => {
        const featured = (p.priceList||[])[0];
        const featured2 = (p.priceList||[])[1];
        const isFollowing = !!state.mp.following[p.id];

        return `
          <div class="bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm">
            <div class="p-4 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                ${printerAvatar(p)}
                <div>
                  <div class="flex items-center gap-2">
                    <button data-open-printer="${p.id}" class="font-extrabold text-gray-900 hover:underline">${p.name}</button>
                    ${p.verified ? `<span class="text-blue-600">${icon('badge-check','w-4 h-4')}</span>` : ''}
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-500 font-black">
                    <span>${p.handle}</span>
                    <span class="text-gray-300">â€¢</span>
                    <span class="flex items-center gap-1">${icon('map-pin','w-3 h-3')} ${p.location}</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button data-follow="${p.id}" class="${followClasses(p.id)} px-3 py-2 rounded-xl text-xs font-extrabold flex items-center gap-2">
                  ${isFollowing ? icon('check','w-4 h-4') : icon('plus','w-4 h-4')}
                  ${followText(p.id)}
                </button>
                <button data-open-printer="${p.id}" class="bg-gray-900 text-white px-3 py-2 rounded-xl text-xs font-extrabold hover:bg-black flex items-center gap-2">
                  ${icon('user','w-4 h-4')} Profile
                </button>
              </div>
            </div>

            <div class="relative">
              <img src="${svgThumb(`${p.name} â€¢ ${featured?.name||'Price List'}`, true)}" class="w-full h-[320px] md:h-[380px] object-cover" alt="post"/>
              <div class="absolute left-4 bottom-4 right-4">
                <div class="bg-black/55 backdrop-blur-md border border-white/10 rounded-2xl p-3 flex items-center justify-between gap-3">
                  <div class="min-w-0">
                    <p class="text-white font-extrabold truncate">${featured ? featured.name : 'Price List'}</p>
                    <div class="flex items-center gap-2 mt-1">
                      ${featured ? pricePill(featured) : ''}
                      <span class="text-[11px] text-white/70 font-black flex items-center gap-1">${icon('clock','w-3 h-3')} ${p.responseMins} mins</span>
                      ${p.delivery ? `<span class="text-[11px] text-white/70 font-black flex items-center gap-1">${icon('truck','w-3 h-3')} Delivery</span>` : `<span class="text-[11px] text-white/70 font-black flex items-center gap-1">${icon('hand','w-3 h-3')} Pickup</span>`}
                    </div>
                  </div>
                  <button data-open-printer="${p.id}" class="bg-white text-gray-900 px-3 py-2 rounded-xl text-xs font-extrabold hover:bg-gray-100 flex items-center gap-2 shrink-0">
                    ${icon('list','w-4 h-4')} Prices
                  </button>
                </div>
              </div>
            </div>

            <div class="p-4 space-y-3">
              <div class="flex items-center justify-between gap-3">
                ${stars(p.rating)}
                <div class="flex items-center gap-2 text-xs text-gray-500 font-black">
                  <span class="font-extrabold text-gray-900">${fmt(p.followers)}</span> followers
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                ${featured ? `
                  <div class="border border-gray-200 rounded-2xl p-3 flex items-center justify-between gap-3">
                    <div class="min-w-0">
                      <p class="font-extrabold text-gray-900 truncate">${featured.name}</p>
                      <p class="text-xs text-gray-500 mt-0.5 font-black">${featured.turnaround} â€¢ Min ${featured.minQty}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                      ${pricePill(featured)}
                      <button data-start-invoice="${p.id}__${featured.sku}" class="text-xs font-extrabold bg-green-600 text-white px-3 py-2 rounded-xl hover:bg-green-700 flex items-center gap-2">
                        ${icon('file-plus','w-4 h-4')} Invoice
                      </button>
                    </div>
                  </div>
                ` : ''}

                ${featured2 ? `
                  <div class="border border-gray-200 rounded-2xl p-3 flex items-center justify-between gap-3">
                    <div class="min-w-0">
                      <p class="font-extrabold text-gray-900 truncate">${featured2.name}</p>
                      <p class="text-xs text-gray-500 mt-0.5 font-black">${featured2.turnaround} â€¢ Min ${featured2.minQty}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                      ${pricePill(featured2)}
                      <button data-start-invoice="${p.id}__${featured2.sku}" class="text-xs font-extrabold bg-green-600 text-white px-3 py-2 rounded-xl hover:bg-green-700 flex items-center gap-2">
                        ${icon('file-plus','w-4 h-4')} Invoice
                      </button>
                    </div>
                  </div>
                ` : ''}
              </div>

              <div class="flex items-center gap-2">
                <button data-open-printer="${p.id}" class="flex-1 bg-gray-900 text-white px-4 py-3 rounded-xl font-extrabold hover:bg-black flex items-center justify-center gap-2">
                  ${icon('shopping-bag','w-5 h-5')} View Profile
                </button>
                <button data-message="${p.id}" class="px-4 py-3 rounded-xl font-extrabold border border-gray-200 hover:bg-gray-50 flex items-center gap-2">
                  ${icon('message-circle','w-5 h-5')} Chat
                </button>
              </div>
            </div>
          </div>
        `;
      };

      const gridCard = (p) => {
        const featured = (p.priceList||[])[0];
        return `
          <div class="bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow">
            <button data-open-printer="${p.id}" class="block w-full text-left">
              <div class="relative">
                <img src="${svgThumb(`${p.name} â€¢ ${featured?.name||'Prices'}`, false)}" class="w-full h-40 object-cover" alt="${p.name}"/>
                <div class="absolute top-3 left-3 flex items-center gap-2">
                  ${p.verified ? `<span class="bg-blue-600 text-white text-[10px] px-2 py-1 rounded-full font-extrabold flex items-center gap-1">${icon('badge-check','w-3 h-3')} Verified</span>` : `<span class="bg-black/70 text-white text-[10px] px-2 py-1 rounded-full font-extrabold">Unverified</span>`}
                </div>
              </div>

              <div class="p-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <p class="font-extrabold text-gray-900 truncate">${p.name}</p>
                    <p class="text-xs text-gray-500 font-black flex items-center gap-1 mt-1">${icon('map-pin','w-3 h-3')} ${p.location}</p>
                  </div>
                  <div class="shrink-0">${stars(p.rating)}</div>
                </div>

                <div class="mt-3 flex items-center justify-between gap-2">
                  <p class="text-xs text-gray-500 font-black">${p.responseMins} mins</p>
                  <p class="text-xs text-gray-500 font-black">${fmt(p.followers)} followers</p>
                </div>

                <div class="mt-3">
                  ${featured ? `
                    <div class="flex items-center justify-between gap-2">
                      <div class="min-w-0">
                        <p class="text-xs font-extrabold text-gray-900 truncate">${featured.name}</p>
                        <p class="text-[10px] text-gray-500 font-black mt-0.5">${featured.turnaround} â€¢ Min ${featured.minQty}</p>
                      </div>
                      ${pricePill(featured)}
                    </div>
                  ` : `<p class="text-xs text-gray-500 font-black">View price list</p>`}
                </div>
              </div>
            </button>

            <div class="p-4 pt-0 flex items-center gap-2">
              ${featured ? `
                <button data-start-invoice="${p.id}__${featured.sku}" class="flex-1 bg-green-600 text-white px-3 py-3 rounded-xl font-extrabold text-xs hover:bg-green-700 flex items-center justify-center gap-2">
                  ${icon('file-plus','w-4 h-4')} Invoice
                </button>
              ` : `
                <button data-open-printer="${p.id}" class="flex-1 bg-gray-900 text-white px-3 py-3 rounded-xl font-extrabold text-xs hover:bg-black flex items-center justify-center gap-2">
                  ${icon('user','w-4 h-4')} Profile
                </button>
              `}
              <button data-follow="${p.id}" class="${followClasses(p.id)} px-3 py-3 rounded-xl text-xs font-extrabold flex items-center gap-2">
                ${state.mp.following[p.id] ? icon('check','w-4 h-4') : icon('plus','w-4 h-4')}
                ${followText(p.id)}
              </button>
            </div>
          </div>
        `;
      };

      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in space-y-4">

              <div class="flex items-center justify-between gap-3">
                <div>
                  <h2 class="text-xl font-extrabold text-gray-900 flex items-center gap-2">
                    ${icon('store','w-5 h-5')} Marketplace
                  </h2>
                  <p class="text-xs text-gray-500 mt-1">List / Grid â€¢ Verified profiles â€¢ Price lists</p>
                </div>

                <div class="flex items-center gap-2">
                  ${(() => {
                    const b1 = viewBtn('list','List','rows-3');
                    const b2 = viewBtn('grid','Grid','layout-grid');
                    return b1 + b2;
                  })()}
                </div>
              </div>

              <div class="bg-white border border-gray-200 rounded-2xl p-3 shadow-sm">
                <div class="flex flex-col sm:flex-row gap-3">
                  <div class="flex-1 relative">
                    <span class="absolute left-3 top-3 text-gray-400">${icon('search','w-4 h-4')}</span>
                    <input id="mpSearch" value="${(state.mp.search||'').replace(/"/g,'&quot;')}" placeholder="Search printers, locations, services..."
                      class="w-full pl-9 pr-3 py-2.5 rounded-2xl border border-gray-200 focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>

                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <select id="mpCategory" class="w-full px-3 py-2.5 rounded-2xl border border-gray-200 bg-white font-black text-sm">
                      ${MARKET_CATEGORIES.map(c => `<option ${state.mp.category===c?'selected':''} value="${c}">${c}</option>`).join('')}
                    </select>

                    <select id="mpLocation" class="w-full px-3 py-2.5 rounded-2xl border border-gray-200 bg-white font-black text-sm">
                      ${uniqLocations().map(l => `<option ${state.mp.location===l?'selected':''} value="${l}">${l}</option>`).join('')}
                    </select>

                    <select id="mpSort" class="w-full px-3 py-2.5 rounded-2xl border border-gray-200 bg-white font-black text-sm col-span-2 sm:col-span-1">
                      ${['Recommended','Rating','Fastest','PriceLow'].map(s => `<option ${state.mp.sort===s?'selected':''} value="${s}">${s}</option>`).join('')}
                    </select>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-xs font-black text-gray-700 uppercase tracking-wider">Trending</p>
                    <p class="text-[11px] text-gray-400 font-black">${printers.length} results</p>
                  </div>
                  <div class="flex gap-3 overflow-x-auto hscroll py-1">
                    ${printers.slice(0,10).map(p => storyBubble(p)).join('')}
                  </div>
                </div>
              </div>

              ${
                isGrid
                  ? `<div class="grid sm:grid-cols-2 gap-4">${printers.map(p => gridCard(p)).join('')}</div>`
                  : `<div class="space-y-4">${printers.map(p => listCard(p)).join('')}</div>`
              }

            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    function renderUpgrade() {
      const current = state.userData?.membershipTier || 'standard';
      const selected = state.upgrade.selectedTier;

      const planRow = (key) => {
        const p = TIERS[key];
        const isCurrent = current === key;
        const isSelected = selected === key;

        const ring = isSelected ? 'ring-2 ring-green-500 border-green-200' : 'border-gray-200';
        const bg = isSelected ? 'bg-green-50' : 'bg-white';

        return `
          <button data-select-tier="${key}" class="w-full text-left ${bg} border ${ring} rounded-2xl p-5 hover:shadow-md transition-all">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-lg font-extrabold text-gray-900">${p.name}</span>
                ${isCurrent ? `<span class="text-[10px] font-extrabold bg-gray-900 text-white px-2 py-1 rounded-full">Current</span>` : ''}
              </div>
              <span class="text-gray-900">${icon(key==='diamond'?'gem':key==='gold'?'crown':'sparkles','w-5 h-5')}</span>
            </div>

            <div class="mt-3 flex items-end justify-between gap-3">
              <div>
                <div class="text-3xl font-extrabold text-gray-900">â‚¦${fmt(p.price)}</div>
                <div class="text-xs text-gray-500 font-black uppercase">${key==='standard'?'':'per month'}</div>
              </div>

              <div class="text-right">
                <div class="text-xs text-gray-500 font-black uppercase">Depth</div>
                <div class="text-lg font-extrabold text-gray-900">${p.depth}</div>
              </div>
            </div>

            <div class="mt-3 text-sm text-gray-700 font-black">
              Network withdrawal unlock: <span class="font-extrabold">${WITHDRAW_RULES[key]} jobs/month</span>
            </div>

            <div class="mt-3 text-xs font-black ${isSelected ? 'text-green-700' : 'text-gray-400'}">
              ${isSelected ? 'Selected' : 'Tap to select'}
            </div>
          </button>
        `;
      };

      const selectedTierObj = selected ? TIERS[selected] : null;

      return `
        <div class="min-h-screen bg-gray-50 pb-20 md:pb-0">
          ${renderTopNav()}

          <div class="max-w-4xl mx-auto p-4">
            <div class="animate-fade-in space-y-5">
              <div class="flex items-center gap-2">
                <button data-nav="dashboard" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                  ${icon('chevron-right','w-5 h-5 rotate-180')}
                </button>
                <div>
                  <h2 class="text-xl font-extrabold text-gray-900">Upgrade</h2>
                  <p class="text-xs text-gray-500 font-black">Choose a plan and pay by transfer.</p>
                </div>
              </div>

              <div class="grid md:grid-cols-3 gap-3">
                ${['silver','gold','diamond'].map(k => planRow(k)).join('')}
              </div>

              ${Card(`
                <div class="space-y-4">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="text-xs text-gray-500 font-black uppercase">Pay to</p>
                      <p class="text-lg font-extrabold text-gray-900">Stanbic IBTC â€¢ 5770438727</p>
                    </div>
                    <button data-action="copy-upgrade-acct" class="px-3 py-2 rounded-xl border border-gray-200 hover:bg-gray-50 font-black text-xs flex items-center gap-2">
                      ${icon('copy','w-4 h-4')} Copy
                    </button>
                  </div>

                  <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
                    <p class="text-xs text-gray-500 font-black uppercase">Selected plan</p>
                    <p class="text-base font-extrabold text-gray-900 mt-1">
                      ${selectedTierObj ? `${selectedTierObj.name} â€¢ â‚¦${fmt(selectedTierObj.price)}` : 'None'}
                    </p>
                    <p class="text-xs text-gray-500 font-black mt-2">
                      Narration: <span class="font-mono">YESPRINT ${state.userData?.myCode || 'CODE'}</span>
                    </p>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-3">
                    ${Button(`${icon('check-circle','w-5 h-5')} Iâ€™ve Paid`, { dataAction:'mark-paid', disabled: !selected, className:'w-full sm:w-auto' })}
                    ${Button(`${icon('sparkles','w-5 h-5')} Activate`, { dataAction:'finalize-upgrade', variant:'black', disabled: !selected || !state.upgrade.paid, className:'w-full sm:w-auto' })}
                    ${Button('Back', { dataNav:'dashboard', variant:'secondary', className:'w-full sm:w-auto' })}
                  </div>

                  <p class="text-xs text-gray-500 font-black">
                    ${state.upgrade.paid ? 'Payment marked. Click Activate.' : 'After payment, click â€œIâ€™ve Paidâ€.'}
                  </p>
                </div>
              `)}
            </div>
          </div>

          ${renderBottomNav()}
        </div>
      `;
    }

    // -----------------------------
    // Printer Profile Modal (unchanged layout, cleaned copy)
    // -----------------------------
    function renderPrinterProfileModal() {
      const pid = state.mp.openPrinterId;
      if (!pid) return '';

      const p = MOCK_PRINTERS.find(x => x.id === pid);
      if (!p) return '';

      const following = !!state.mp.following[p.id];
      const prices = (p.priceList||[]);

      return `
        <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto animate-fade-in">
          <div class="bg-white w-full max-w-3xl rounded-2xl overflow-hidden shadow-2xl">
            <div class="relative">
              <img src="${svgThumb(`${p.name}`, true)}" class="w-full h-48 object-cover" alt="cover"/>
              <button id="btnClosePrinter" class="absolute top-3 right-3 bg-white/90 hover:bg-white text-gray-900 rounded-full p-2 shadow">
                ${icon('x','w-5 h-5')}
              </button>

              <div class="absolute -bottom-8 left-4 flex items-end gap-3">
                <div class="w-20 h-20 rounded-full ring-4 ring-white overflow-hidden bg-gray-100 shadow">
                  <img src="${svgThumb(p.handle,false)}" class="w-full h-full object-cover" alt="avatar"/>
                </div>
                <div class="pb-2">
                  <div class="flex items-center gap-2">
                    <h3 class="text-xl font-extrabold text-white drop-shadow">${p.name}</h3>
                    ${p.verified ? `<span class="text-blue-200 drop-shadow">${icon('badge-check','w-5 h-5')}</span>` : ''}
                  </div>
                  <p class="text-xs text-white/80 drop-shadow flex items-center gap-2 font-black">
                    <span>${p.handle}</span>
                    <span class="text-white/40">â€¢</span>
                    <span class="flex items-center gap-1">${icon('map-pin','w-3 h-3')} ${p.location}</span>
                  </p>
                </div>
              </div>
            </div>

            <div class="pt-12 p-6 space-y-5">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-3">
                  ${p.verified ? badgeVerified() : `<span class="inline-flex items-center gap-1 text-xs font-extrabold bg-gray-100 text-gray-700 border border-gray-200 px-2 py-0.5 rounded-full">${icon('alert-triangle','w-4 h-4')} Unverified</span>`}
                  ${stars(p.rating)}
                  <span class="text-xs text-gray-500 font-black flex items-center gap-1">${icon('clock','w-4 h-4')} ${p.responseMins} mins</span>
                  <span class="text-xs text-gray-500 font-black flex items-center gap-1">${icon('users','w-4 h-4')} ${fmt(p.followers)}</span>
                </div>

                <div class="flex items-center gap-2">
                  <button data-follow="${p.id}" class="${followClasses(p.id)} px-4 py-2 rounded-xl text-sm font-extrabold flex items-center gap-2">
                    ${following ? icon('check','w-4 h-4') : icon('plus','w-4 h-4')}
                    ${followText(p.id)}
                  </button>
                  <button data-message="${p.id}" class="bg-gray-900 text-white px-4 py-2 rounded-xl text-sm font-extrabold hover:bg-black flex items-center gap-2">
                    ${icon('message-circle','w-4 h-4')} Chat
                  </button>
                </div>
              </div>

              <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 flex items-start gap-3">
                <div class="mt-0.5">${icon('shield-check','w-5 h-5 text-green-700')}</div>
                <div class="min-w-0">
                  <p class="font-extrabold text-gray-900 text-sm">Verification</p>
                  <p class="text-xs text-gray-600 mt-1 font-black">
                    ${p.verified ? `Verified printer on YesPrint.` : `Not verified yet. Confirm details before you confirm payment.`}
                  </p>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <h4 class="font-extrabold text-gray-900 flex items-center gap-2">
                  ${icon('list','w-5 h-5')} Price List
                </h4>
                <p class="text-xs text-gray-500 font-black">${p.minOrderNote}</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${prices.map(item => `
                  <div class="border border-gray-200 rounded-2xl overflow-hidden">
                    <div class="h-28 bg-gray-900">
                      <img src="${svgThumb(item.name,false)}" class="w-full h-full object-cover" alt="${item.name}"/>
                    </div>
                    <div class="p-4 space-y-2">
                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                          <p class="font-extrabold text-gray-900 truncate">${item.name}</p>
                          <p class="text-xs text-gray-500 mt-0.5 font-black">${item.category} â€¢ ${item.turnaround} â€¢ Min ${item.minQty}</p>
                        </div>
                        ${pricePill(item)}
                      </div>

                      <div class="flex items-center gap-2">
                        <button data-start-invoice="${p.id}__${item.sku}" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-xl font-extrabold text-xs hover:bg-green-700 flex items-center justify-center gap-2">
                          ${icon('file-plus','w-4 h-4')} Create Invoice
                        </button>
                        <button data-quote="${p.id}__${item.sku}" class="px-3 py-2 rounded-xl font-extrabold text-xs border border-gray-200 hover:bg-gray-50 flex items-center gap-2">
                          ${icon('send','w-4 h-4')} Quote
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>

              <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <button id="btnClosePrinter2" class="w-full sm:w-auto px-5 py-3 rounded-xl font-extrabold border border-gray-200 hover:bg-gray-50 flex items-center justify-center gap-2">
                  ${icon('arrow-left','w-4 h-4')} Back
                </button>
                <button data-message="${p.id}" class="w-full sm:w-auto px-5 py-3 rounded-xl font-extrabold bg-gray-900 text-white hover:bg-black flex items-center justify-center gap-2">
                  ${icon('message-circle','w-4 h-4')} Message
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // -----------------------------
    // Invoice Modal (PNG download)
    // -----------------------------
    function renderInvoiceModal() {
      if (!state.showInvoice || !state.pendingJob || !state.userData) return '';
      const job = state.pendingJob;
      const statusPill = job.status === 'Completed'
        ? 'bg-green-100 text-green-700'
        : 'bg-yellow-100 text-yellow-700';

      return `
        <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto animate-fade-in">
          <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">

            <div id="invoiceCapture">
              <div class="bg-gray-900 text-white p-6 text-center">
                <div class="flex justify-center mb-2">
                  <div class="bg-white p-2 rounded-lg">${icon('printer','text-gray-900 w-6 h-6')}</div>
                </div>
                <h2 class="text-xl font-extrabold uppercase tracking-widest">Invoice</h2>
                <p class="text-gray-400 text-xs font-black">YesPrint</p>
              </div>

              <div class="p-8 space-y-6">
                <div class="text-center">
                  <p class="text-gray-500 text-xs uppercase font-black">Pay to</p>
                  <h3 class="text-lg font-extrabold text-gray-800">${job.businessName}</h3>
                  <div class="inline-block px-3 py-1 rounded-full text-xs font-extrabold mt-2 ${statusPill}">
                    ${job.status === 'Completed' ? 'PAID' : 'PENDING'}
                  </div>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-2xl p-4 text-center">
                  <p class="text-gray-500 text-xs uppercase mb-1 font-black">Amount</p>
                  <h1 class="text-4xl font-extrabold text-green-700">â‚¦${fmt(job.amount)}</h1>
                </div>

                <div class="border-t border-b border-gray-100 py-4 space-y-3">
                  <div class="flex justify-between font-black">
                    <span class="text-gray-500">Bank</span>
                    <span class="font-extrabold">Stanbic IBTC</span>
                  </div>
                  <div class="flex justify-between items-center font-black">
                    <span class="text-gray-500">Account</span>
                    <span class="font-mono text-xl font-extrabold tracking-wider">5770438727</span>
                  </div>
                  <div class="flex justify-between font-black">
                    <span class="text-gray-500">Reference</span>
                    <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${String(job.id).substring(4, 12).toUpperCase()}</span>
                  </div>
                  <div class="flex justify-between font-black">
                    <span class="text-gray-500">Agent</span>
                    <span class="font-extrabold">${state.userData.fullName}</span>
                  </div>
                  <div class="flex justify-between font-black">
                    <span class="text-gray-500">Category</span>
                    <span class="font-extrabold">${job.jobType}</span>
                  </div>
                </div>

                <div class="text-center text-xs text-gray-400 font-black">
                  Download this invoice as PNG and send to the client if needed.
                </div>
              </div>
            </div>

            <div class="p-6 pt-0 space-y-3 capture-exclude">
              <div class="flex items-center justify-between gap-2">
                <button id="btnCopyAcct" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 hover:bg-gray-50 font-extrabold text-xs flex items-center justify-center gap-2">
                  ${icon('copy','w-4 h-4')} Copy
                </button>
                <button data-action="download-invoice" class="flex-1 px-4 py-3 rounded-xl bg-gray-900 text-white hover:bg-black font-extrabold text-xs flex items-center justify-center gap-2">
                  ${icon('download','w-4 h-4')} Download PNG
                </button>
              </div>

              ${
                job.status !== 'Completed'
                ? Button(`${icon('check-circle','w-4 h-4')} Confirm Payment`, { dataAction:'confirm-pay', className:'w-full bg-green-600 hover:bg-green-700' })
                : ''
              }

              <div class="flex gap-3">
                ${Button('Close', { variant:'secondary', dataAction:'close-invoice', className:'flex-1' })}
              </div>
            </div>

          </div>
        </div>
      `;
    }

    // -----------------------------
    // Master Render
    // -----------------------------
    function render() {
      const root = el('app');
      const modalRoot = el('modalRoot');

      let html = '';
      if (state.view === 'landing') html = renderLanding();
      else if (state.view === 'auth') html = renderAuth();
      else if (state.view === 'dashboard') html = renderDashboard();
      else if (state.view === 'new-job') html = renderNewJob();
      else if (state.view === 'network') html = renderNetwork();
      else if (state.view === 'wallet') html = renderWallet();
      else if (state.view === 'payment-success') html = renderPaymentSuccess();
      else if (state.view === 'marketplace') html = renderMarketplace();
      else if (state.view === 'upgrade') html = renderUpgrade();
      else html = renderLanding();

      root.innerHTML = html;

      modalRoot.innerHTML = `
        ${renderFlash()}
        ${renderInvoiceModal()}
        ${renderPrinterProfileModal()}
      `;

      if (window.lucide?.createIcons) window.lucide.createIcons();
      bindEvents();
    }

    // -----------------------------
    // Event Binding
    // -----------------------------
    function bindEvents() {
      // Landing
      const btnJoin = el('btnJoin');
      const btnLogin = el('btnLogin');
      const btnStart = el('btnStart');
      if (btnJoin) btnJoin.onclick = () => { state.isRegistering = true; state.view = 'auth'; render(); };
      if (btnStart) btnStart.onclick = () => { state.isRegistering = true; state.view = 'auth'; render(); };
      if (btnLogin) btnLogin.onclick = () => { state.isRegistering = false; state.view = 'auth'; render(); };

      // Auth
      const btnBackToHome = el('btnBackToHome');
      const btnToggleAuth = el('btnToggleAuth');
      const authForm = el('authForm');
      if (btnBackToHome) btnBackToHome.onclick = () => setView('landing');
      if (btnToggleAuth) btnToggleAuth.onclick = () => { state.isRegistering = !state.isRegistering; render(); };
      if (authForm) {
        [...authForm.elements].forEach(inp => {
          if (!inp.name) return;
          if (state.authForm[inp.name] != null && inp.value === '') inp.value = state.authForm[inp.name];
          inp.oninput = (e) => updateAuthForm(inp.name, e.target.value);
        });
        authForm.onsubmit = handleAuthSubmit;
      }

      // Universal NAV
      document.querySelectorAll('[data-nav]').forEach(b => {
        b.onclick = () => setView(b.getAttribute('data-nav'));
      });

      // Jobs: open invoice
      document.querySelectorAll('[data-open-invoice]').forEach(b => {
        b.onclick = () => {
          const id = b.getAttribute('data-open-invoice');
          const job = state.jobs.find(j => j.id === id);
          if (!job) return;
          state.pendingJob = job;
          state.showInvoice = true;
          render();
        };
      });

      document.querySelectorAll('[data-confirm-job]').forEach(b => {
        b.onclick = () => {
          const id = b.getAttribute('data-confirm-job');
          if (confirm("Confirming means you have verified the transfer. Proceed?")) {
            confirmJobPayment(id);
          }
        };
      });

      // New Job form
      const jobForm = el('jobForm');
      if (jobForm) {
        if (state.jobDraft) {
          const d = state.jobDraft;
          if (d.businessId) jobForm.businessId.value = d.businessId;
          if (d.jobTitle) jobForm.jobTitle.value = d.jobTitle;
          if (d.jobType) jobForm.jobType.value = d.jobType;
          if (d.costPrice != null) jobForm.costPrice.value = d.costPrice;
          if (d.margin != null) jobForm.margin.value = d.margin;
        }

        const jobTypeSelect = el('jobTypeSelect');
        const customWrap = el('customTypeWrap');

        function syncCustomUI() {
          if (!jobTypeSelect || !customWrap) return;
          const isCustom = jobTypeSelect.value === 'Custom';
          customWrap.classList.toggle('hidden', !isCustom);
          const customInput = jobForm.customJobType;
          if (customInput) customInput.required = isCustom;
        }

        if (jobTypeSelect) {
          jobTypeSelect.onchange = () => syncCustomUI();
          // init
          syncCustomUI();
        }

        jobForm.onsubmit = (e) => {
          e.preventDefault();
          generateInvoiceFromForm(jobForm);
        };
      }

      // Wallet actions
      document.querySelectorAll('[data-action="withdraw-direct"]').forEach(b => b.onclick = () => handleDirectWithdrawalRequest());
      document.querySelectorAll('[data-action="withdraw-network"]').forEach(b => b.onclick = () => handleNetworkWithdrawalRequest());

      // Invoice modal actions
      const btnCopyAcct = el('btnCopyAcct');
      if (btnCopyAcct) btnCopyAcct.onclick = () => copyText('5770438727');
      document.querySelectorAll('[data-action="close-invoice"]').forEach(b => b.onclick = () => closeInvoice(true));
      document.querySelectorAll('[data-action="download-invoice"]').forEach(b => b.onclick = () => downloadInvoicePng());
      document.querySelectorAll('[data-action="confirm-pay"]').forEach(b => {
        b.onclick = () => {
          if (!state.pendingJob) return;
          if (confirm("Confirming means you have verified the transfer. Proceed?")) {
            confirmJobPayment(state.pendingJob.id);
          }
        };
      });

      // Marketplace view type
      document.querySelectorAll('[data-mp-view]').forEach(b => {
        b.onclick = () => {
          state.mp.viewType = b.getAttribute('data-mp-view');
          render();
        };
      });

      // Marketplace filters
      const mpSearch = el('mpSearch');
      const mpCategory = el('mpCategory');
      const mpLocation = el('mpLocation');
      const mpSort = el('mpSort');
      if (mpSearch) mpSearch.oninput = (e) => { state.mp.search = e.target.value; render(); };
      if (mpCategory) mpCategory.onchange = (e) => { state.mp.category = e.target.value; render(); };
      if (mpLocation) mpLocation.onchange = (e) => { state.mp.location = e.target.value; render(); };
      if (mpSort) mpSort.onchange = (e) => { state.mp.sort = e.target.value; render(); };

      // Marketplace open profile
      document.querySelectorAll('[data-open-printer]').forEach(b => {
        b.onclick = () => openPrinterProfile(b.getAttribute('data-open-printer'));
      });

      // Marketplace follow toggle
      document.querySelectorAll('[data-follow]').forEach(b => {
        b.onclick = () => {
          const pid = b.getAttribute('data-follow');
          state.mp.following[pid] = !state.mp.following[pid];
          render();
        };
      });

      // Marketplace message
      document.querySelectorAll('[data-message]').forEach(b => {
        b.onclick = () => {
          const pid = b.getAttribute('data-message');
          const p = MOCK_PRINTERS.find(x=>x.id===pid);
          toast('success', `Opening chat with ${p ? p.name : 'printer'}... (demo)`);
        };
      });

      // Marketplace quote
      document.querySelectorAll('[data-quote]').forEach(b => {
        b.onclick = () => {
          const [pid, sku] = b.getAttribute('data-quote').split('__');
          const p = MOCK_PRINTERS.find(x=>x.id===pid);
          const item = p?.priceList?.find(i=>i.sku===sku);
          toast('success', `Quote sent: ${item ? item.name : 'item'} (${p ? p.name : ''})`);
        };
      });

      // Marketplace start invoice
      document.querySelectorAll('[data-start-invoice]').forEach(b => {
        b.onclick = () => {
          const [pid, sku] = b.getAttribute('data-start-invoice').split('__');
          startInvoiceFromItem(pid, sku);
        };
      });

      // Printer profile modal close
      const btnClosePrinter = el('btnClosePrinter');
      const btnClosePrinter2 = el('btnClosePrinter2');
      if (btnClosePrinter) btnClosePrinter.onclick = () => closePrinterProfile();
      if (btnClosePrinter2) btnClosePrinter2.onclick = () => closePrinterProfile();

      // Upgrade page
      document.querySelectorAll('[data-select-tier]').forEach(b => {
        b.onclick = () => selectUpgradeTier(b.getAttribute('data-select-tier'));
      });
      document.querySelectorAll('[data-action="copy-upgrade-acct"]').forEach(b => b.onclick = () => copyText('5770438727'));
      document.querySelectorAll('[data-action="mark-paid"]').forEach(b => b.onclick = () => { markUpgradePaid(); toast('success', 'Payment marked.'); });
      document.querySelectorAll('[data-action="finalize-upgrade"]').forEach(b => b.onclick = () => finalizeUpgrade());
    }

    // -----------------------------
    // Boot
    // -----------------------------
    render();
  </script>
</body>
</html>
